#!/usr/bin/env python3
"""
ãƒ©ã‚¤ãƒ–ãƒ©ãƒªUI - ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦
ã‚·ãƒ³ãƒ—ãƒ«ãªtkinterãƒ™ãƒ¼ã‚¹ã®ãŠæ°—ã«å…¥ã‚Šç®¡ç†UI
"""

import tkinter as tk
from tkinter import ttk, messagebox, simpledialog
from typing import List, Dict, Optional, Callable
from simple_library import SimpleLibrary


class LibraryUI:
    """ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦"""
    
    def __init__(self, parent_window: Optional[tk.Tk] = None):
        """
        åˆæœŸåŒ–
        
        Args:
            parent_window: è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        """
        self.parent_window = parent_window
        self.window: Optional[tk.Toplevel] = None
        self.library = SimpleLibrary()
        self.favorites_listbox: Optional[tk.Listbox] = None
        self.detail_text: Optional[tk.Text] = None
        
        print("ãƒ©ã‚¤ãƒ–ãƒ©ãƒªUIãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ")
    
    def show_favorites_window(self):
        """ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º"""
        try:
            if self.window and self.window.winfo_exists():
                # æ—¢ã«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆã¯å‰é¢ã«è¡¨ç¤º
                self.window.lift()
                self.window.focus_force()
                return
            
            # æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆ
            self._create_window()
            self._create_widgets()
            self._load_favorites()
            
        except Exception as e:
            print(f"ãŠæ°—ã«å…¥ã‚Šã‚¦ã‚£ãƒ³ãƒ‰ã‚¦è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: {e}")
            messagebox.showerror("ã‚¨ãƒ©ãƒ¼", f"ãŠæ°—ã«å…¥ã‚Šã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
    
    def _create_window(self):
        """ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆ"""
        if self.parent_window:
            self.window = tk.Toplevel(self.parent_window)
        else:
            self.window = tk.Toplevel()
        
        self.window.title("ğŸ“š ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ - SENPAI")
        self.window.geometry("800x600")
        self.window.resizable(True, True)
        
        # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä¸­å¤®ã«é…ç½®
        self.window.transient(self.parent_window)
        if self.parent_window:
            self.window.grab_set()  # ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ã™ã‚‹
    
    def _create_widgets(self):
        """ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’ä½œæˆ"""
        # ãƒ¡ã‚¤ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ 
        main_frame = ttk.Frame(self.window)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=10, pady=10)
        
        # ã‚¿ã‚¤ãƒˆãƒ«
        title_label = ttk.Label(
            main_frame, 
            text="ğŸ“š ãŠæ°—ã«å…¥ã‚Šä¸€è¦§", 
            font=('Arial', 14, 'bold')
        )
        title_label.pack(pady=(0, 10))
        
        # ä¸Šéƒ¨ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆæ¤œç´¢ã¨ãƒœã‚¿ãƒ³ï¼‰
        top_frame = ttk.Frame(main_frame)
        top_frame.pack(fill=tk.X, pady=(0, 10))
        
        # æ¤œç´¢ãƒ•ãƒ¬ãƒ¼ãƒ 
        search_frame = ttk.Frame(top_frame)
        search_frame.pack(side=tk.LEFT, fill=tk.X, expand=True)
        
        ttk.Label(search_frame, text="ğŸ” æ¤œç´¢:").pack(side=tk.LEFT)
        self.search_var = tk.StringVar()
        self.search_entry = ttk.Entry(search_frame, textvariable=self.search_var)
        self.search_entry.pack(side=tk.LEFT, fill=tk.X, expand=True, padx=(5, 0))
        self.search_entry.bind('<KeyRelease>', self._on_search)
        
        # ãƒœã‚¿ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ 
        button_frame = ttk.Frame(top_frame)
        button_frame.pack(side=tk.RIGHT, padx=(10, 0))
        
        # æ›´æ–°ãƒœã‚¿ãƒ³
        refresh_button = ttk.Button(
            button_frame, 
            text="ğŸ”„ æ›´æ–°", 
            command=self._load_favorites
        )
        refresh_button.pack(side=tk.LEFT, padx=(0, 5))))\n        \n        # ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆå·¦å³åˆ†å‰²ï¼‰\n        content_frame = ttk.Frame(main_frame)\n        content_frame.pack(fill=tk.BOTH, expand=True)\n        \n        # å·¦å´ï¼šãŠæ°—ã«å…¥ã‚Šä¸€è¦§\n        left_frame = ttk.LabelFrame(content_frame, text=\"ãŠæ°—ã«å…¥ã‚Šä¸€è¦§\")\n        left_frame.pack(side=tk.LEFT, fill=tk.BOTH, expand=True, padx=(0, 5))\n        \n        # ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹\n        listbox_frame = ttk.Frame(left_frame)\n        listbox_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)\n        \n        self.favorites_listbox = tk.Listbox(\n            listbox_frame,\n            font=('Arial', 10),\n            selectmode=tk.SINGLE\n        )\n        self.favorites_listbox.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)\n        \n        # ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼\n        scrollbar = ttk.Scrollbar(listbox_frame, orient=tk.VERTICAL)\n        scrollbar.pack(side=tk.RIGHT, fill=tk.Y)\n        self.favorites_listbox.config(yscrollcommand=scrollbar.set)\n        scrollbar.config(command=self.favorites_listbox.yview)\n        \n        # ãƒªã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆ\n        self.favorites_listbox.bind('<<ListboxSelect>>', self._on_select_favorite)\n        self.favorites_listbox.bind('<Double-Button-1>', self._on_double_click)\n        \n        # å·¦å´ãƒœã‚¿ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ \n        left_button_frame = ttk.Frame(left_frame)\n        left_button_frame.pack(fill=tk.X, padx=5, pady=(0, 5))\n        \n        ttk.Button(\n            left_button_frame, \n            text=\"ğŸ—‘ï¸ å‰Šé™¤\", \n            command=self._delete_selected_favorite\n        ).pack(side=tk.LEFT, padx=(0, 5))\n        \n        # å³å´ï¼šè©³ç´°è¡¨ç¤º\n        right_frame = ttk.LabelFrame(content_frame, text=\"è©³ç´°\")\n        right_frame.pack(side=tk.RIGHT, fill=tk.BOTH, expand=True, padx=(5, 0))\n        \n        # è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆ\n        detail_frame = ttk.Frame(right_frame)\n        detail_frame.pack(fill=tk.BOTH, expand=True, padx=5, pady=5)\n        \n        self.detail_text = tk.Text(\n            detail_frame,\n            wrap=tk.WORD,\n            font=('Arial', 10),\n            state=tk.DISABLED\n        )\n        self.detail_text.pack(side=tk.LEFT, fill=tk.BOTH, expand=True)\n        \n        # è©³ç´°ç”¨ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼\n        detail_scrollbar = ttk.Scrollbar(detail_frame, orient=tk.VERTICAL)\n        detail_scrollbar.pack(side=tk.RIGHT, fill=tk.Y)\n        self.detail_text.config(yscrollcommand=detail_scrollbar.set)\n        detail_scrollbar.config(command=self.detail_text.yview)\n        \n        # ä¸‹éƒ¨ãƒœã‚¿ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ \n        bottom_frame = ttk.Frame(main_frame)\n        bottom_frame.pack(fill=tk.X, pady=(10, 0))\n        \n        # çµ±è¨ˆæƒ…å ±\n        self.stats_label = ttk.Label(bottom_frame, text=\"\")\n        self.stats_label.pack(side=tk.LEFT)\n        \n        # é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³\n        close_button = ttk.Button(\n            bottom_frame, \n            text=\"âŒ é–‰ã˜ã‚‹\", \n            command=self._close_window\n        )\n        close_button.pack(side=tk.RIGHT)\n    \n    def _load_favorites(self):\n        \"\"\"ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã‚’èª­ã¿è¾¼ã¿\"\"\"\n        try:\n            # ãƒªã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢\n            if self.favorites_listbox:\n                self.favorites_listbox.delete(0, tk.END)\n            \n            # ãŠæ°—ã«å…¥ã‚Šã‚’å–å¾—\n            favorites = self.library.get_favorites_list()\n            \n            # ãƒªã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ \n            for favorite in favorites:\n                created_at = favorite.get('created_at', '')[:16].replace('T', ' ')\n                tag = favorite.get('tag', 'æœªåˆ†é¡')\n                question = favorite.get('question', 'è³ªå•ãªã—')\n                \n                display_text = f\"[{tag}] {question} ({created_at})\"\n                self.favorites_listbox.insert(tk.END, display_text)\n            \n            # çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°\n            count = len(favorites)\n            self.stats_label.config(text=f\"ğŸ“Š ç·æ•°: {count}ä»¶\")\n            \n            # è©³ç´°ã‚’ã‚¯ãƒªã‚¢\n            self._clear_detail()\n            \n            print(f\"ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: {count}ä»¶\")\n            \n        except Exception as e:\n            print(f\"ãŠæ°—ã«å…¥ã‚Šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}\")\n            messagebox.showerror(\"ã‚¨ãƒ©ãƒ¼\", f\"ãŠæ°—ã«å…¥ã‚Šã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}\")\n    \n    def _on_search(self, event):\n        \"\"\"æ¤œç´¢å‡¦ç†\"\"\"\n        try:\n            search_text = self.search_var.get().lower()\n            \n            # å…¨ãŠæ°—ã«å…¥ã‚Šã‚’å–å¾—\n            all_favorites = self.library.get_favorites_list()\n            \n            # ãƒªã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢\n            self.favorites_listbox.delete(0, tk.END)\n            \n            # ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã—ã¦è¡¨ç¤º\n            filtered_count = 0\n            for favorite in all_favorites:\n                question = favorite.get('question', '').lower()\n                tag = favorite.get('tag', '').lower()\n                \n                if search_text in question or search_text in tag:\n                    created_at = favorite.get('created_at', '')[:16].replace('T', ' ')\n                    tag_display = favorite.get('tag', 'æœªåˆ†é¡')\n                    question_display = favorite.get('question', 'è³ªå•ãªã—')\n                    \n                    display_text = f\"[{tag_display}] {question_display} ({created_at})\"\n                    self.favorites_listbox.insert(tk.END, display_text)\n                    filtered_count += 1\n            \n            # çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°\n            total_count = len(all_favorites)\n            if search_text:\n                self.stats_label.config(text=f\"ğŸ“Š æ¤œç´¢çµæœ: {filtered_count}ä»¶ / ç·æ•°: {total_count}ä»¶\")\n            else:\n                self.stats_label.config(text=f\"ğŸ“Š ç·æ•°: {total_count}ä»¶\")\n                \n        except Exception as e:\n            print(f\"æ¤œç´¢ã‚¨ãƒ©ãƒ¼: {e}\")\n    \n    def _on_select_favorite(self, event):\n        \"\"\"ãŠæ°—ã«å…¥ã‚Šé¸æŠæ™‚ã®å‡¦ç†\"\"\"\n        try:\n            selection = self.favorites_listbox.curselection()\n            if not selection:\n                return\n            \n            # é¸æŠã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—\n            index = selection[0]\n            \n            # ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãŠæ°—ã«å…¥ã‚Šãƒªã‚¹ãƒˆã‚’å–å¾—\n            search_text = self.search_var.get().lower()\n            if search_text:\n                # æ¤œç´¢çµæœã‹ã‚‰å–å¾—\n                all_favorites = self.library.get_favorites_list()\n                filtered_favorites = []\n                for favorite in all_favorites:\n                    question = favorite.get('question', '').lower()\n                    tag = favorite.get('tag', '').lower()\n                    if search_text in question or search_text in tag:\n                        filtered_favorites.append(favorite)\n                favorites = filtered_favorites\n            else:\n                # å…¨ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å–å¾—\n                favorites = self.library.get_favorites_list()\n            \n            if index < len(favorites):\n                favorite_id = favorites[index]['id']\n                self._show_favorite_detail(favorite_id)\n                \n        except Exception as e:\n            print(f\"ãŠæ°—ã«å…¥ã‚Šé¸æŠã‚¨ãƒ©ãƒ¼: {e}\")\n    \n    def _on_double_click(self, event):\n        \"\"\"ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯æ™‚ã®å‡¦ç†ï¼ˆè©³ç´°è¡¨ç¤ºï¼‰\"\"\"\n        # ç¾åœ¨ã¯é¸æŠæ™‚ã¨åŒã˜å‡¦ç†\n        self._on_select_favorite(event)\n    \n    def _show_favorite_detail(self, favorite_id: str):\n        \"\"\"ãŠæ°—ã«å…¥ã‚Šã®è©³ç´°ã‚’è¡¨ç¤º\"\"\"\n        try:\n            favorite = self.library.get_favorite(favorite_id)\n            if not favorite:\n                self._clear_detail()\n                return\n            \n            # è©³ç´°ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°\n            self.detail_text.config(state=tk.NORMAL)\n            self.detail_text.delete(1.0, tk.END)\n            \n            # è©³ç´°æƒ…å ±ã‚’æ§‹ç¯‰\n            detail_lines = []\n            detail_lines.append(f\"ğŸ“ è³ªå•:\")\n            detail_lines.append(favorite.get('question', 'è³ªå•ãªã—'))\n            detail_lines.append(\"\")\n            detail_lines.append(f\"ğŸ’¡ å›ç­”:\")\n            detail_lines.append(favorite.get('answer', 'å›ç­”ãªã—'))\n            detail_lines.append(\"\")\n            detail_lines.append(f\"ğŸ·ï¸ ã‚¿ã‚°: {favorite.get('tag', 'æœªåˆ†é¡')}\")\n            detail_lines.append(f\"ğŸ“… ä½œæˆæ—¥æ™‚: {favorite.get('created_at', 'ä¸æ˜')[:19].replace('T', ' ')}\")\n            \n            if favorite.get('screenshot_path'):\n                detail_lines.append(f\"ğŸ“· ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆ: {favorite['screenshot_path']}\")\n            \n            detail_text = \"\\n\".join(detail_lines)\n            self.detail_text.insert(1.0, detail_text)\n            self.detail_text.config(state=tk.DISABLED)\n            \n        except Exception as e:\n            print(f\"è©³ç´°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: {e}\")\n            self._clear_detail()\n    \n    def _clear_detail(self):\n        \"\"\"è©³ç´°è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢\"\"\"\n        try:\n            if self.detail_text:\n                self.detail_text.config(state=tk.NORMAL)\n                self.detail_text.delete(1.0, tk.END)\n                self.detail_text.insert(1.0, \"ãŠæ°—ã«å…¥ã‚Šã‚’é¸æŠã—ã¦ãã ã•ã„\")\n                self.detail_text.config(state=tk.DISABLED)\n        except Exception as e:\n            print(f\"è©³ç´°ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼: {e}\")\n    \n    def _delete_selected_favorite(self):\n        \"\"\"é¸æŠã•ã‚ŒãŸãŠæ°—ã«å…¥ã‚Šã‚’å‰Šé™¤\"\"\"\n        try:\n            selection = self.favorites_listbox.curselection()\n            if not selection:\n                messagebox.showwarning(\"è­¦å‘Š\", \"å‰Šé™¤ã™ã‚‹ãŠæ°—ã«å…¥ã‚Šã‚’é¸æŠã—ã¦ãã ã•ã„\")\n                return\n            \n            # å‰Šé™¤ç¢ºèª\n            result = messagebox.askyesno(\n                \"å‰Šé™¤ç¢ºèª\", \n                \"é¸æŠã•ã‚ŒãŸãŠæ°—ã«å…¥ã‚Šã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\\n\\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\"\n            )\n            if not result:\n                return\n            \n            # é¸æŠã•ã‚ŒãŸãŠæ°—ã«å…¥ã‚ŠIDã‚’å–å¾—\n            index = selection[0]\n            search_text = self.search_var.get().lower()\n            \n            if search_text:\n                # æ¤œç´¢çµæœã‹ã‚‰å–å¾—\n                all_favorites = self.library.get_favorites_list()\n                filtered_favorites = []\n                for favorite in all_favorites:\n                    question = favorite.get('question', '').lower()\n                    tag = favorite.get('tag', '').lower()\n                    if search_text in question or search_text in tag:\n                        filtered_favorites.append(favorite)\n                favorites = filtered_favorites\n            else:\n                # å…¨ãŠæ°—ã«å…¥ã‚Šã‹ã‚‰å–å¾—\n                favorites = self.library.get_favorites_list()\n            \n            if index < len(favorites):\n                favorite_id = favorites[index]['id']\n                \n                # å‰Šé™¤å®Ÿè¡Œ\n                if self.library.delete_favorite(favorite_id):\n                    messagebox.showinfo(\"æˆåŠŸ\", \"ãŠæ°—ã«å…¥ã‚Šã‚’å‰Šé™¤ã—ã¾ã—ãŸ\")\n                    # ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿\n                    self._load_favorites()\n                else:\n                    messagebox.showerror(\"ã‚¨ãƒ©ãƒ¼\", \"ãŠæ°—ã«å…¥ã‚Šã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ\")\n                    \n        except Exception as e:\n            print(f\"ãŠæ°—ã«å…¥ã‚Šå‰Šé™¤ã‚¨ãƒ©ãƒ¼: {e}\")\n            messagebox.showerror(\"ã‚¨ãƒ©ãƒ¼\", f\"ãŠæ°—ã«å…¥ã‚Šã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}\")\n    \n    def _close_window(self):\n        \"\"\"ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã‚‹\"\"\"\n        try:\n            if self.window:\n                self.window.destroy()\n                self.window = None\n                print(\"ãŠæ°—ã«å…¥ã‚Šã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¾ã—ãŸ\")\n        except Exception as e:\n            print(f\"ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦çµ‚äº†ã‚¨ãƒ©ãƒ¼: {e}\")\n\n\nclass FavoriteSaveDialog:\n    \"\"\"ãŠæ°—ã«å…¥ã‚Šä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°\"\"\"\n    \n    def __init__(self, parent_window: tk.Tk, question: str, answer: str):\n        \"\"\"\n        åˆæœŸåŒ–\n        \n        Args:\n            parent_window: è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦\n            question: è³ªå•ãƒ†ã‚­ã‚¹ãƒˆ\n            answer: å›ç­”ãƒ†ã‚­ã‚¹ãƒˆ\n        \"\"\"\n        self.parent_window = parent_window\n        self.question = question\n        self.answer = answer\n        self.result = None\n        self.dialog: Optional[tk.Toplevel] = None\n    \n    def show_dialog(self) -> Optional[str]:\n        \"\"\"\n        ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¦ã‚¿ã‚°ã‚’å–å¾—\n        \n        Returns:\n            str: å…¥åŠ›ã•ã‚ŒãŸã‚¿ã‚°ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯Noneï¼‰\n        \"\"\"\n        try:\n            # ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆ\n            self.dialog = tk.Toplevel(self.parent_window)\n            self.dialog.title(\"â­ ãŠæ°—ã«å…¥ã‚Šã«ä¿å­˜\")\n            self.dialog.geometry(\"400x300\")\n            self.dialog.resizable(False, False)\n            self.dialog.transient(self.parent_window)\n            self.dialog.grab_set()\n            \n            # ä¸­å¤®ã«é…ç½®\n            self.dialog.geometry(\"+%d+%d\" % (\n                self.parent_window.winfo_rootx() + 50,\n                self.parent_window.winfo_rooty() + 50\n            ))\n            \n            # ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’ä½œæˆ\n            self._create_dialog_widgets()\n            \n            # ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‰ã˜ã‚‰ã‚Œã‚‹ã¾ã§å¾…æ©Ÿ\n            self.dialog.wait_window()\n            \n            return self.result\n            \n        except Exception as e:\n            print(f\"ãŠæ°—ã«å…¥ã‚Šä¿å­˜ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚¨ãƒ©ãƒ¼: {e}\")\n            return None\n    \n    def _create_dialog_widgets(self):\n        \"\"\"ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆã‚’ä½œæˆ\"\"\"\n        main_frame = ttk.Frame(self.dialog)\n        main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)\n        \n        # ã‚¿ã‚¤ãƒˆãƒ«\n        title_label = ttk.Label(\n            main_frame, \n            text=\"â­ ãŠæ°—ã«å…¥ã‚Šã«ä¿å­˜\", \n            font=('Arial', 12, 'bold')\n        )\n        title_label.pack(pady=(0, 15))\n        \n        # è³ªå•ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼\n        question_frame = ttk.LabelFrame(main_frame, text=\"è³ªå•\")\n        question_frame.pack(fill=tk.X, pady=(0, 10))\n        \n        question_text = tk.Text(\n            question_frame, \n            height=3, \n            wrap=tk.WORD, \n            state=tk.DISABLED,\n            font=('Arial', 9)\n        )\n        question_text.pack(fill=tk.X, padx=5, pady=5)\n        question_text.config(state=tk.NORMAL)\n        question_text.insert(1.0, self.question)\n        question_text.config(state=tk.DISABLED)\n        \n        # ã‚¿ã‚°å…¥åŠ›\n        tag_frame = ttk.LabelFrame(main_frame, text=\"ã‚¿ã‚°ï¼ˆåˆ†é¡ç”¨ï¼‰\")\n        tag_frame.pack(fill=tk.X, pady=(0, 15))\n        \n        self.tag_var = tk.StringVar()\n        tag_entry = ttk.Entry(tag_frame, textvariable=self.tag_var, font=('Arial', 10))\n        tag_entry.pack(fill=tk.X, padx=5, pady=5)\n        tag_entry.focus_set()\n        \n        # ã‚¿ã‚°ã®ä¾‹\n        example_label = ttk.Label(\n            tag_frame, \n            text=\"ä¾‹: ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯, ãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œ, è¨­å®šå¤‰æ›´\", \n            font=('Arial', 8),\n            foreground='gray'\n        )\n        example_label.pack(padx=5, pady=(0, 5))\n        \n        # ãƒœã‚¿ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ \n        button_frame = ttk.Frame(main_frame)\n        button_frame.pack(fill=tk.X)\n        \n        # ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³\n        cancel_button = ttk.Button(\n            button_frame, \n            text=\"âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«\", \n            command=self._cancel\n        )\n        cancel_button.pack(side=tk.RIGHT, padx=(5, 0))\n        \n        # ä¿å­˜ãƒœã‚¿ãƒ³\n        save_button = ttk.Button(\n            button_frame, \n            text=\"â­ ä¿å­˜\", \n            command=self._save\n        )\n        save_button.pack(side=tk.RIGHT)\n        \n        # Enterã‚­ãƒ¼ã§ä¿å­˜\n        self.dialog.bind('<Return>', lambda e: self._save())\n        self.dialog.bind('<Escape>', lambda e: self._cancel())\n    \n    def _save(self):\n        \"\"\"ä¿å­˜å‡¦ç†\"\"\"\n        self.result = self.tag_var.get().strip()\n        if self.dialog:\n            self.dialog.destroy()\n    \n    def _cancel(self):\n        \"\"\"ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†\"\"\"\n        self.result = None\n        if self.dialog:\n            self.dialog.destroy()\n\n\ndef test_library_ui():\n    \"\"\"ãƒ©ã‚¤ãƒ–ãƒ©ãƒªUIã®ãƒ†ã‚¹ãƒˆ\"\"\"\n    print(\"=== ãƒ©ã‚¤ãƒ–ãƒ©ãƒªUI ãƒ†ã‚¹ãƒˆ ===\")\n    \n    # ãƒ†ã‚¹ãƒˆç”¨ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’ä½œæˆ\n    root = tk.Tk()\n    root.title(\"ãƒ†ã‚¹ãƒˆ\")\n    root.geometry(\"300x200\")\n    \n    # ãƒ©ã‚¤ãƒ–ãƒ©ãƒªUIã‚’ä½œæˆ\n    library_ui = LibraryUI(root)\n    \n    # ãƒ†ã‚¹ãƒˆç”¨ãƒœã‚¿ãƒ³\n    test_button = ttk.Button(\n        root, \n        text=\"ğŸ“š ãŠæ°—ã«å…¥ã‚Šä¸€è¦§ã‚’é–‹ã\", \n        command=library_ui.show_favorites_window\n    )\n    test_button.pack(pady=50)\n    \n    # ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’è¡¨ç¤º\n    root.mainloop()\n\n\nif __name__ == \"__main__\":\n    test_library_ui()"
